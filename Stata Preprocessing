* Step 1
* Determine Common Variables Between Datasets and Append Years

* Load the first dataset and get its variable list
use "Y:\Tyler Zander\NSQIP\NSQIP_2021.dta", clear
ds
local commonvars `r(varlist)'

* Compare with the second dataset
use "Y:\Tyler Zander\NSQIP\NSQIP 2020.dta", clear
ds
local tempvarlist `r(varlist)'
local commonvars : list commonvars & tempvarlist

* Compare with the third dataset
use "Y:\Tyler Zander\NSQIP\NSQIP 2019.dta", clear
ds
local tempvarlist `r(varlist)'
local commonvars : list commonvars & tempvarlist

* Compare with the fourth dataset
use "Y:\Tyler Zander\NSQIP\NSQIP 2018.dta", clear
ds
local tempvarlist `r(varlist)'
local commonvars : list commonvars & tempvarlist

* Display the common variables
display "Common variables: `commonvars'"

* Count the number of common variables
local numvars = wordcount("`commonvars'")
display "Number of common variables: `numvars'"

*COMMON VARIABLES BETWEEN 2018-2021
*\PUFYEAR CaseID SEX RACE_NEW ETHNICITY_HISPANIC PRNCPTX CPT WORKRVU INOUT TRANST Age AdmYR OperYR DISCHDEST ANESTHES SURGSPEC HEIGHT WEIGHT DIABETES SMOKE FNSTATUS2 VENTILAT HXCOPD ASCITES HXCHF HYPERMED DIALYSIS DISCANCR STEROID BLEEDDIS TRANSFUS PRSEPIS DPRNA DPRBUN DPRCREAT DPRALBUM DPRBILI DPRSGOT DPRALKP DPRWBC DPRHCT DPRPLATE DPRPTT DPRINR PRSODM PRBUN PRCREAT PRALBUM PRBILI PRSGOT PRALKPH PRWBC PRHCT PRPLATE PRPTT PRINR OTHERPROC1 OTHERCPT1 OTHERWRVU1 OTHERPROC2 OTHERCPT2 OTHERWRVU2 OTHERPROC3 OTHERCPT3 OTHERWRVU3 OTHERPROC4 OTHERCPT4 OTHERWRVU4 OTHERPROC5 OTHERCPT5 OTHERWRVU5 OTHERPROC6 OTHERCPT6 OTHERWRVU6 OTHERPROC7 OTHERCPT7 OTHERWRVU7 OTHERPROC8 OTHERCPT8 OTHERWRVU8 OTHERPROC9 OTHERCPT9 OTHERWRVU9 OTHERPROC10 OTHERCPT10 OTHERWRVU10 CONCURR1 CONCPT1 CONWRVU1 CONCURR2 CONCPT2 CONWRVU2 CONCURR3 CONCPT3 CONWRVU3 CONCURR4 CONCPT4 CONWRVU4 CONCURR5 CONCPT5 CONWRVU5 CONCURR6 CONCPT6 CONWRVU6 CONCURR7 CONCPT7 CONWRVU7 CONCURR8 CONCPT8 CONWRVU8 CONCURR9 CONCPT9 CONWRVU9 CONCURR10 CONCPT10 CONWRVU10 ASACLAS MORTPROB MORBPROB OPTIME HDISDT YRDEATH TOTHLOS AdmQtr HtoODay NSUPINFEC SUPINFEC SSSIPATOS DSUPINFEC NWNDINFD WNDINFD DSSIPATOS DWNDINFD NORGSPCSSI ORGSPCSSI OSSIPATOS DORGSPCSSI NDEHIS DEHIS DDEHIS NOUPNEUMO OUPNEUMO PNAPATOS DOUPNEUMO NREINTUB REINTUB DREINTUB NPULEMBOL PULEMBOL DPULEMBOL NFAILWEAN FAILWEAN VENTPATOS DFAILWEAN NOPRENAFL OPRENAFL DOPRENAFL NURNINFEC URNINFEC UTIPATOS DURNINFEC NCNSCVA CNSCVA DCNSCVA NCDARREST CDARREST  DCDARREST NCDMI CDMI DCDMI NOTHBLEED OTHBLEED DOTHBLEED NOTHDVT OTHDVT DOTHDVT NOTHSYSEP OTHSYSEP SEPSISPATOS DOTHSYSEP NOTHSESHOCK OTHSESHOCK SEPSHOCKPATOS DOTHSESHOCK PODIAG10 PODIAGTX10 RETURNOR DOpertoD DOptoDis STILLINHOSP  REOPERATION1 RETORPODAYS REOPORCPT1 RETORRELATED REOPOR1ICD101 REOPERATION2 RETOR2PODAYS REOPOR2CPT1 RETOR2RELATED REOPOR2ICD101 REOPERATION3 READMISSION1 READMPODAYS1 UNPLANNEDREADMISSION1 READMRELATED1 READMSUSPREASON1 READMUNRELSUSP1 READMRELICD101 READMUNRELICD101 READMISSION2 READMPODAYS2 UNPLANNEDREADMISSION2 READMRELATED2 READMSUSPREASON2 READMUNRELSUSP2 READMRELICD102 READMUNRELICD102 READMISSION3 READMPODAYS3 UNPLANNEDREADMISSION3 READMRELATED3 READMSUSPREASON3 READMUNRELSUSP3 READMRELICD103 READMUNRELICD103 READMISSION4 READMPODAYS4 UNPLANNEDREADMISSION4 READMRELATED4 READMSUSPREASON4 READMUNRELSUSP4 READMRELICD104 READMUNRELICD104 READMISSION5 READMPODAYS5 UNPLANNEDREADMISSION5 READMRELATED5 READMSUSPREASON5 READMUNRELSUSP5 READMRELICD105 READMUNRELICD105 PODIAG_OTHER10 ANESTHES_OTHER OTHCDIFF NOTHCDIFF DOTHCDIFF
\*

clear
use "Y:\Tyler Zander\NSQIP\NSQIP_2021.dta"

keep PUFYEAR CaseID SEX RACE_NEW ETHNICITY_HISPANIC PRNCPTX CPT WORKRVU INOUT TRANST Age AdmYR OperYR DISCHDEST ANESTHES SURGSPEC HEIGHT WEIGHT DIABETES SMOKE FNSTATUS2 VENTILAT HXCOPD ASCITES HXCHF HYPERMED DIALYSIS DISCANCR STEROID BLEEDDIS TRANSFUS PRSEPIS DPRNA DPRBUN DPRCREAT DPRALBUM DPRBILI DPRSGOT DPRALKP DPRWBC DPRHCT DPRPLATE DPRPTT DPRINR PRSODM PRBUN PRCREAT PRALBUM PRBILI PRSGOT PRALKPH PRWBC PRHCT PRPLATE PRPTT PRINR OTHERPROC1 OTHERCPT1 OTHERWRVU1 OTHERPROC2 OTHERCPT2 OTHERWRVU2 OTHERPROC3 OTHERCPT3 OTHERWRVU3 OTHERPROC4 OTHERCPT4 OTHERWRVU4 OTHERPROC5 OTHERCPT5 OTHERWRVU5 OTHERPROC6 OTHERCPT6 OTHERWRVU6 OTHERPROC7 OTHERCPT7 OTHERWRVU7 OTHERPROC8 OTHERCPT8 OTHERWRVU8 OTHERPROC9 OTHERCPT9 OTHERWRVU9 OTHERPROC10 OTHERCPT10 OTHERWRVU10 CONCURR1 CONCPT1 CONWRVU1 CONCURR2 CONCPT2 CONWRVU2 CONCURR3 CONCPT3 CONWRVU3 CONCURR4 CONCPT4 CONWRVU4 CONCURR5 CONCPT5 CONWRVU5 CONCURR6 CONCPT6 CONWRVU6 CONCURR7 CONCPT7 CONWRVU7 CONCURR8 CONCPT8 CONWRVU8 CONCURR9 CONCPT9 CONWRVU9 CONCURR10 CONCPT10 CONWRVU10 ASACLAS MORTPROB MORBPROB OPTIME HDISDT YRDEATH TOTHLOS AdmQtr HtoODay NSUPINFEC SUPINFEC SSSIPATOS DSUPINFEC NWNDINFD WNDINFD DSSIPATOS DWNDINFD NORGSPCSSI ORGSPCSSI OSSIPATOS DORGSPCSSI NDEHIS DEHIS DDEHIS NOUPNEUMO OUPNEUMO PNAPATOS DOUPNEUMO NREINTUB REINTUB DREINTUB NPULEMBOL PULEMBOL DPULEMBOL NFAILWEAN FAILWEAN VENTPATOS DFAILWEAN NOPRENAFL OPRENAFL DOPRENAFL NURNINFEC URNINFEC UTIPATOS DURNINFEC NCNSCVA CNSCVA DCNSCVA NCDARREST CDARREST  DCDARREST NCDMI CDMI DCDMI NOTHBLEED OTHBLEED DOTHBLEED NOTHDVT OTHDVT DOTHDVT NOTHSYSEP OTHSYSEP SEPSISPATOS DOTHSYSEP NOTHSESHOCK OTHSESHOCK SEPSHOCKPATOS DOTHSESHOCK PODIAG10 PODIAGTX10 RETURNOR DOpertoD DOptoDis STILLINHOSP  REOPERATION1 RETORPODAYS REOPORCPT1 RETORRELATED REOPOR1ICD101 REOPERATION2 RETOR2PODAYS REOPOR2CPT1 RETOR2RELATED REOPOR2ICD101 REOPERATION3 READMISSION1 READMPODAYS1 UNPLANNEDREADMISSION1 READMRELATED1 READMSUSPREASON1 READMUNRELSUSP1 READMRELICD101 READMUNRELICD101 READMISSION2 READMPODAYS2 UNPLANNEDREADMISSION2 READMRELATED2 READMSUSPREASON2 READMUNRELSUSP2 READMRELICD102 READMUNRELICD102 READMISSION3 READMPODAYS3 UNPLANNEDREADMISSION3 READMRELATED3 READMSUSPREASON3 READMUNRELSUSP3 READMRELICD103 READMUNRELICD103 READMISSION4 READMPODAYS4 UNPLANNEDREADMISSION4 READMRELATED4 READMSUSPREASON4 READMUNRELSUSP4 READMRELICD104 READMUNRELICD104 READMISSION5 READMPODAYS5 UNPLANNEDREADMISSION5 READMRELATED5 READMSUSPREASON5 READMUNRELSUSP5 READMRELICD105 READMUNRELICD105 PODIAG_OTHER10 ANESTHES_OTHER OTHCDIFF NOTHCDIFF DOTHCDIFF

save "Y:\Tyler Zander\NSQIP\NSQIP_2021V2.dta", replace

clear
use "Y:\Tyler Zander\NSQIP\NSQIP 2020.dta"

keep PUFYEAR CaseID SEX RACE_NEW ETHNICITY_HISPANIC PRNCPTX CPT WORKRVU INOUT TRANST Age AdmYR OperYR DISCHDEST ANESTHES SURGSPEC HEIGHT WEIGHT DIABETES SMOKE FNSTATUS2 VENTILAT HXCOPD ASCITES HXCHF HYPERMED DIALYSIS DISCANCR STEROID BLEEDDIS TRANSFUS PRSEPIS DPRNA DPRBUN DPRCREAT DPRALBUM DPRBILI DPRSGOT DPRALKP DPRWBC DPRHCT DPRPLATE DPRPTT DPRINR PRSODM PRBUN PRCREAT PRALBUM PRBILI PRSGOT PRALKPH PRWBC PRHCT PRPLATE PRPTT PRINR OTHERPROC1 OTHERCPT1 OTHERWRVU1 OTHERPROC2 OTHERCPT2 OTHERWRVU2 OTHERPROC3 OTHERCPT3 OTHERWRVU3 OTHERPROC4 OTHERCPT4 OTHERWRVU4 OTHERPROC5 OTHERCPT5 OTHERWRVU5 OTHERPROC6 OTHERCPT6 OTHERWRVU6 OTHERPROC7 OTHERCPT7 OTHERWRVU7 OTHERPROC8 OTHERCPT8 OTHERWRVU8 OTHERPROC9 OTHERCPT9 OTHERWRVU9 OTHERPROC10 OTHERCPT10 OTHERWRVU10 CONCURR1 CONCPT1 CONWRVU1 CONCURR2 CONCPT2 CONWRVU2 CONCURR3 CONCPT3 CONWRVU3 CONCURR4 CONCPT4 CONWRVU4 CONCURR5 CONCPT5 CONWRVU5 CONCURR6 CONCPT6 CONWRVU6 CONCURR7 CONCPT7 CONWRVU7 CONCURR8 CONCPT8 CONWRVU8 CONCURR9 CONCPT9 CONWRVU9 CONCURR10 CONCPT10 CONWRVU10 ASACLAS MORTPROB MORBPROB OPTIME HDISDT YRDEATH TOTHLOS AdmQtr HtoODay NSUPINFEC SUPINFEC SSSIPATOS DSUPINFEC NWNDINFD WNDINFD DSSIPATOS DWNDINFD NORGSPCSSI ORGSPCSSI OSSIPATOS DORGSPCSSI NDEHIS DEHIS DDEHIS NOUPNEUMO OUPNEUMO PNAPATOS DOUPNEUMO NREINTUB REINTUB DREINTUB NPULEMBOL PULEMBOL DPULEMBOL NFAILWEAN FAILWEAN VENTPATOS DFAILWEAN NOPRENAFL OPRENAFL DOPRENAFL NURNINFEC URNINFEC UTIPATOS DURNINFEC NCNSCVA CNSCVA DCNSCVA NCDARREST CDARREST  DCDARREST NCDMI CDMI DCDMI NOTHBLEED OTHBLEED DOTHBLEED NOTHDVT OTHDVT DOTHDVT NOTHSYSEP OTHSYSEP SEPSISPATOS DOTHSYSEP NOTHSESHOCK OTHSESHOCK SEPSHOCKPATOS DOTHSESHOCK PODIAG10 PODIAGTX10 RETURNOR DOpertoD DOptoDis STILLINHOSP  REOPERATION1 RETORPODAYS REOPORCPT1 RETORRELATED REOPOR1ICD101 REOPERATION2 RETOR2PODAYS REOPOR2CPT1 RETOR2RELATED REOPOR2ICD101 REOPERATION3 READMISSION1 READMPODAYS1 UNPLANNEDREADMISSION1 READMRELATED1 READMSUSPREASON1 READMUNRELSUSP1 READMRELICD101 READMUNRELICD101 READMISSION2 READMPODAYS2 UNPLANNEDREADMISSION2 READMRELATED2 READMSUSPREASON2 READMUNRELSUSP2 READMRELICD102 READMUNRELICD102 READMISSION3 READMPODAYS3 UNPLANNEDREADMISSION3 READMRELATED3 READMSUSPREASON3 READMUNRELSUSP3 READMRELICD103 READMUNRELICD103 READMISSION4 READMPODAYS4 UNPLANNEDREADMISSION4 READMRELATED4 READMSUSPREASON4 READMUNRELSUSP4 READMRELICD104 READMUNRELICD104 READMISSION5 READMPODAYS5 UNPLANNEDREADMISSION5 READMRELATED5 READMSUSPREASON5 READMUNRELSUSP5 READMRELICD105 READMUNRELICD105 PODIAG_OTHER10 ANESTHES_OTHER OTHCDIFF NOTHCDIFF DOTHCDIFF

save "Y:\Tyler Zander\NSQIP\NSQIP_2020V2.dta", replace

clear
use "Y:\Tyler Zander\NSQIP\NSQIP 2019.dta"

keep PUFYEAR CaseID SEX RACE_NEW ETHNICITY_HISPANIC PRNCPTX CPT WORKRVU INOUT TRANST Age AdmYR OperYR DISCHDEST ANESTHES SURGSPEC HEIGHT WEIGHT DIABETES SMOKE FNSTATUS2 VENTILAT HXCOPD ASCITES HXCHF HYPERMED DIALYSIS DISCANCR STEROID BLEEDDIS TRANSFUS PRSEPIS DPRNA DPRBUN DPRCREAT DPRALBUM DPRBILI DPRSGOT DPRALKP DPRWBC DPRHCT DPRPLATE DPRPTT DPRINR PRSODM PRBUN PRCREAT PRALBUM PRBILI PRSGOT PRALKPH PRWBC PRHCT PRPLATE PRPTT PRINR OTHERPROC1 OTHERCPT1 OTHERWRVU1 OTHERPROC2 OTHERCPT2 OTHERWRVU2 OTHERPROC3 OTHERCPT3 OTHERWRVU3 OTHERPROC4 OTHERCPT4 OTHERWRVU4 OTHERPROC5 OTHERCPT5 OTHERWRVU5 OTHERPROC6 OTHERCPT6 OTHERWRVU6 OTHERPROC7 OTHERCPT7 OTHERWRVU7 OTHERPROC8 OTHERCPT8 OTHERWRVU8 OTHERPROC9 OTHERCPT9 OTHERWRVU9 OTHERPROC10 OTHERCPT10 OTHERWRVU10 CONCURR1 CONCPT1 CONWRVU1 CONCURR2 CONCPT2 CONWRVU2 CONCURR3 CONCPT3 CONWRVU3 CONCURR4 CONCPT4 CONWRVU4 CONCURR5 CONCPT5 CONWRVU5 CONCURR6 CONCPT6 CONWRVU6 CONCURR7 CONCPT7 CONWRVU7 CONCURR8 CONCPT8 CONWRVU8 CONCURR9 CONCPT9 CONWRVU9 CONCURR10 CONCPT10 CONWRVU10 ASACLAS MORTPROB MORBPROB OPTIME HDISDT YRDEATH TOTHLOS AdmQtr HtoODay NSUPINFEC SUPINFEC SSSIPATOS DSUPINFEC NWNDINFD WNDINFD DSSIPATOS DWNDINFD NORGSPCSSI ORGSPCSSI OSSIPATOS DORGSPCSSI NDEHIS DEHIS DDEHIS NOUPNEUMO OUPNEUMO PNAPATOS DOUPNEUMO NREINTUB REINTUB DREINTUB NPULEMBOL PULEMBOL DPULEMBOL NFAILWEAN FAILWEAN VENTPATOS DFAILWEAN NOPRENAFL OPRENAFL DOPRENAFL NURNINFEC URNINFEC UTIPATOS DURNINFEC NCNSCVA CNSCVA DCNSCVA NCDARREST CDARREST  DCDARREST NCDMI CDMI DCDMI NOTHBLEED OTHBLEED DOTHBLEED NOTHDVT OTHDVT DOTHDVT NOTHSYSEP OTHSYSEP SEPSISPATOS DOTHSYSEP NOTHSESHOCK OTHSESHOCK SEPSHOCKPATOS DOTHSESHOCK PODIAG10 PODIAGTX10 RETURNOR DOpertoD DOptoDis STILLINHOSP  REOPERATION1 RETORPODAYS REOPORCPT1 RETORRELATED REOPOR1ICD101 REOPERATION2 RETOR2PODAYS REOPOR2CPT1 RETOR2RELATED REOPOR2ICD101 REOPERATION3 READMISSION1 READMPODAYS1 UNPLANNEDREADMISSION1 READMRELATED1 READMSUSPREASON1 READMUNRELSUSP1 READMRELICD101 READMUNRELICD101 READMISSION2 READMPODAYS2 UNPLANNEDREADMISSION2 READMRELATED2 READMSUSPREASON2 READMUNRELSUSP2 READMRELICD102 READMUNRELICD102 READMISSION3 READMPODAYS3 UNPLANNEDREADMISSION3 READMRELATED3 READMSUSPREASON3 READMUNRELSUSP3 READMRELICD103 READMUNRELICD103 READMISSION4 READMPODAYS4 UNPLANNEDREADMISSION4 READMRELATED4 READMSUSPREASON4 READMUNRELSUSP4 READMRELICD104 READMUNRELICD104 READMISSION5 READMPODAYS5 UNPLANNEDREADMISSION5 READMRELATED5 READMSUSPREASON5 READMUNRELSUSP5 READMRELICD105 READMUNRELICD105 PODIAG_OTHER10 ANESTHES_OTHER OTHCDIFF NOTHCDIFF DOTHCDIFF

save "Y:\Tyler Zander\NSQIP\NSQIP_2019V2.dta", replace

clear
use "Y:\Tyler Zander\NSQIP\NSQIP 2018.dta"

keep PUFYEAR CaseID SEX RACE_NEW ETHNICITY_HISPANIC PRNCPTX CPT WORKRVU INOUT TRANST Age AdmYR OperYR DISCHDEST ANESTHES SURGSPEC HEIGHT WEIGHT DIABETES SMOKE FNSTATUS2 VENTILAT HXCOPD ASCITES HXCHF HYPERMED DIALYSIS DISCANCR STEROID BLEEDDIS TRANSFUS PRSEPIS DPRNA DPRBUN DPRCREAT DPRALBUM DPRBILI DPRSGOT DPRALKP DPRWBC DPRHCT DPRPLATE DPRPTT DPRINR PRSODM PRBUN PRCREAT PRALBUM PRBILI PRSGOT PRALKPH PRWBC PRHCT PRPLATE PRPTT PRINR OTHERPROC1 OTHERCPT1 OTHERWRVU1 OTHERPROC2 OTHERCPT2 OTHERWRVU2 OTHERPROC3 OTHERCPT3 OTHERWRVU3 OTHERPROC4 OTHERCPT4 OTHERWRVU4 OTHERPROC5 OTHERCPT5 OTHERWRVU5 OTHERPROC6 OTHERCPT6 OTHERWRVU6 OTHERPROC7 OTHERCPT7 OTHERWRVU7 OTHERPROC8 OTHERCPT8 OTHERWRVU8 OTHERPROC9 OTHERCPT9 OTHERWRVU9 OTHERPROC10 OTHERCPT10 OTHERWRVU10 CONCURR1 CONCPT1 CONWRVU1 CONCURR2 CONCPT2 CONWRVU2 CONCURR3 CONCPT3 CONWRVU3 CONCURR4 CONCPT4 CONWRVU4 CONCURR5 CONCPT5 CONWRVU5 CONCURR6 CONCPT6 CONWRVU6 CONCURR7 CONCPT7 CONWRVU7 CONCURR8 CONCPT8 CONWRVU8 CONCURR9 CONCPT9 CONWRVU9 CONCURR10 CONCPT10 CONWRVU10 ASACLAS MORTPROB MORBPROB OPTIME HDISDT YRDEATH TOTHLOS AdmQtr HtoODay NSUPINFEC SUPINFEC SSSIPATOS DSUPINFEC NWNDINFD WNDINFD DSSIPATOS DWNDINFD NORGSPCSSI ORGSPCSSI OSSIPATOS DORGSPCSSI NDEHIS DEHIS DDEHIS NOUPNEUMO OUPNEUMO PNAPATOS DOUPNEUMO NREINTUB REINTUB DREINTUB NPULEMBOL PULEMBOL DPULEMBOL NFAILWEAN FAILWEAN VENTPATOS DFAILWEAN NOPRENAFL OPRENAFL DOPRENAFL NURNINFEC URNINFEC UTIPATOS DURNINFEC NCNSCVA CNSCVA DCNSCVA NCDARREST CDARREST  DCDARREST NCDMI CDMI DCDMI NOTHBLEED OTHBLEED DOTHBLEED NOTHDVT OTHDVT DOTHDVT NOTHSYSEP OTHSYSEP SEPSISPATOS DOTHSYSEP NOTHSESHOCK OTHSESHOCK SEPSHOCKPATOS DOTHSESHOCK PODIAG10 PODIAGTX10 RETURNOR DOpertoD DOptoDis STILLINHOSP  REOPERATION1 RETORPODAYS REOPORCPT1 RETORRELATED REOPOR1ICD101 REOPERATION2 RETOR2PODAYS REOPOR2CPT1 RETOR2RELATED REOPOR2ICD101 REOPERATION3 READMISSION1 READMPODAYS1 UNPLANNEDREADMISSION1 READMRELATED1 READMSUSPREASON1 READMUNRELSUSP1 READMRELICD101 READMUNRELICD101 READMISSION2 READMPODAYS2 UNPLANNEDREADMISSION2 READMRELATED2 READMSUSPREASON2 READMUNRELSUSP2 READMRELICD102 READMUNRELICD102 READMISSION3 READMPODAYS3 UNPLANNEDREADMISSION3 READMRELATED3 READMSUSPREASON3 READMUNRELSUSP3 READMRELICD103 READMUNRELICD103 READMISSION4 READMPODAYS4 UNPLANNEDREADMISSION4 READMRELATED4 READMSUSPREASON4 READMUNRELSUSP4 READMRELICD104 READMUNRELICD104 READMISSION5 READMPODAYS5 UNPLANNEDREADMISSION5 READMRELATED5 READMSUSPREASON5 READMUNRELSUSP5 READMRELICD105 READMUNRELICD105 PODIAG_OTHER10 ANESTHES_OTHER OTHCDIFF NOTHCDIFF DOTHCDIFF

save "Y:\Tyler Zander\NSQIP\NSQIP_2018V2.dta", replace

clear
use "Y:\Tyler Zander\NSQIP\NSQIP_2021V2.dta"

append using "Y:\Tyler Zander\NSQIP\NSQIP_2020V2.dta"
append using "Y:\Tyler Zander\NSQIP\NSQIP_2019V2.dta"
append using "Y:\Tyler Zander\NSQIP\NSQIP_2018V2.dta"

save "Y:\Tyler Zander\NSQIP\NSQIP_2018_2021V3.dta", replace

*****************************************************************
*Step 2: Inclusion/Exclusion

clear
use "Y:\Tyler Zander\NSQIP\NSQIP_2018_2021V3.dta"
*3,983,771 patients

keep if OTHSYSEP == "Sepsis" | OTHSESHOCK == "Septic Shock"
* dropped 3,890,070
* remain 93,701

* Make -99 values missing values
* List of variables
local vars HEIGHT WEIGHT PRSODM PRBUN PRCREAT PRALBUM PRBILI PRSGOT PRALKPH PRWBC PRHCT PRPLATE PRPTT PRINR OPTIME HtoODay TOTHLOS DOTHSYSEP DOTHSESHOCK DOptoDis

* Loop through each variable and replace -99 with missing value
foreach var in `vars' {
    replace `var' = . if `var' == -99
}

drop if DOptoDis == .
*7,996 deleted

keep if DOTHSESHOCK < DOptoDis | DOTHSYSEP < DOptoDis
* dropped 24,898
* remain 60,807

drop if DISCHDEST == "Expired"
* dropped 8,595
* 52,212 remain

drop if DISCHDEST == "Against Medical Advice (AMA)"
*313 dropped
*51,899 remain

tab DISCHDEST

drop if DISCHDEST == "Acute Care Hospital" | DISCHDEST == "Separate Acute Care"
*1,673 dropped
*50,226 remain

drop if DISCHDEST == "Hospice"
*1,172 dropped
*49,054 remain

*Drop if age >90
drop if Age == "90+"
*775 dropped
*48,279 remain

count if DOptoDis > 30

tab DOptoDis UNPLANNEDREADMISSION1

tab READMPODAYS1

drop if DOptoDis > 30
*279 dropped
*48,000 remain

summarize DOptoDis, detail

save "Y:\Tyler Zander\NSQIP\Z4_NSQIP_2018_2021V4.dta", replace

*****************************************************************
*Step 3: Exclude length of stay > 16 days to avoid immortal person time bias. Capture 14-day readmissions.

clear
use "Y:\Tyler Zander\NSQIP\Z4_NSQIP_2018_2021V4.dta"

drop if DOptoDis > 16
*10,563 deleted
*37,437 remain

tab UNPLANNEDREADMISSION1
mdesc UNPLANNEDREADMISSION1

tab READMPODAYS1
mdesc READMPODAYS1

*Drop if readmission day missing
keep if READMPODAYS1 > -1 & READMPODAYS1 < 31 | UNPLANNEDREADMISSION1 == "No" | UNPLANNEDREADMISSION1 == "NULL"
*9 deleted

gen DCtoReadmit = READMPODAYS1 - DOptoDis

*Change UNPLANNEDREADMISSION1 to be 14-day readmission only
gen UNPLANNEDREADMISSION1Z = "No"

replace UNPLANNEDREADMISSION1Z = "Yes"  if DCtoReadmit == 0 & UNPLANNEDREADMISSION1 == "Yes" | DCtoReadmit == 1 & UNPLANNEDREADMISSION1 == "Yes" | DCtoReadmit == 2 & UNPLANNEDREADMISSION1 == "Yes" | DCtoReadmit == 3 & UNPLANNEDREADMISSION1 == "Yes" | DCtoReadmit == 4 & UNPLANNEDREADMISSION1 == "Yes" | DCtoReadmit == 5 & UNPLANNEDREADMISSION1 == "Yes" | DCtoReadmit == 6 & UNPLANNEDREADMISSION1 == "Yes" | DCtoReadmit == 7 & UNPLANNEDREADMISSION1 == "Yes" | DCtoReadmit == 8 & UNPLANNEDREADMISSION1 == "Yes" | DCtoReadmit == 9 & UNPLANNEDREADMISSION1 == "Yes" | DCtoReadmit == 10 & UNPLANNEDREADMISSION1 == "Yes" | DCtoReadmit == 11 & UNPLANNEDREADMISSION1 == "Yes" | DCtoReadmit == 12 & UNPLANNEDREADMISSION1 == "Yes" | DCtoReadmit == 13 & UNPLANNEDREADMISSION1 == "Yes" | DCtoReadmit == 14 & UNPLANNEDREADMISSION1 == "Yes"

drop UNPLANNEDREADMISSION1
rename UNPLANNEDREADMISSION1Z UNPLANNEDREADMISSION1

tab UNPLANNEDREADMISSION1

save "Y:\Tyler Zander\NSQIP\Z4_NSQIP_2018_2021V5.dta", replace

*****************************************************************
*Step 4: Feature Engineering

clear
use "Y:\Tyler Zander\NSQIP\Z4_NSQIP_2018_2021V5.dta"

destring Age, replace
tostring CaseID, replace

*Address ASA Class
* Generate a new numeric variable with missing values
gen ASACLASS = .

* Recode the string values to corresponding numeric values
replace ASACLASS = 1 if ASACLAS == "1-No Disturb"
replace ASACLASS = 2 if ASACLAS == "2-Mild Disturb"
replace ASACLASS = 3 if ASACLAS == "3-Severe Disturb"
replace ASACLASS = 4 if ASACLAS == "4-Life Threat"
replace ASACLASS = 5 if ASACLAS == "5-Moribund"
* "None assigned" will remain as missing value

* Optionally, you can drop the original string variable if no longer needed
drop ASACLAS

* Optionally, rename the new variable to the original name if desired
rename ASACLASS ASACLAS

*Address Null Values
replace UNPLANNEDREADMISSION1 = "No" if UNPLANNEDREADMISSION1 == "NULL"

* List of variables
local vars ETHNICITY_HISPANIC TRANST DISCHDEST ANESTHES FNSTATUS2

* Loop through each variable and replace "Unknown" with missing string value
foreach var in `vars' {
    replace `var' = "" if `var' == "Unknown"
}

save "Y:\Tyler Zander\NSQIP\Z4_NSQIP_2018_2021V6.dta", replace

*****************************************************************
*Step 5: Generate variables for complications during index admission

clear
use "Y:\Tyler Zander\NSQIP\Z4_NSQIP_2018_2021V6.dta"

gen InitialShock = "No"
replace InitialShock = "Yes" if DOTHSESHOCK < DOptoDis

gen InitialSepsis = "No"
replace InitialSepsis = "Yes" if DOTHSYSEP < DOptoDis

tab InitialSepsis
tab InitialShock

*Now create initial complication variables
*First, replace -99 values to missing values 
* List of variables
local vars DSUPINFEC DWNDINFD DORGSPCSSI DDEHIS DOUPNEUMO DREINTUB DPULEMBOL DFAILWEAN DOPRENAFL DURNINFEC DCNSCVA DCDARREST DCDMI DOTHBLEED DOTHDVT RETORPODAYS DOTHCDIFF

* Loop through each variable and replace -99 with missing value
foreach var in `vars' {
    replace `var' = . if `var' == -99
}

gen InitialSUPINFEC = "No"
replace InitialSUPINFEC = "Yes" if DSUPINFEC < DOptoDis

gen InitialWNDINFD = "No"
replace InitialWNDINFD = "Yes" if DWNDINFD < DOptoDis

gen InitialORGSPCSSI = "No"
replace InitialORGSPCSSI = "Yes" if DORGSPCSSI < DOptoDis

gen InitialDEHIS = "No"
replace InitialDEHIS = "Yes" if DDEHIS < DOptoDis

gen InitialOUPNEUMO = "No"
replace InitialOUPNEUMO = "Yes" if DOUPNEUMO < DOptoDis

gen InitialREINTUB = "No"
replace InitialREINTUB = "Yes" if DREINTUB < DOptoDis

gen InitialPULEMBOL = "No"
replace InitialPULEMBOL = "Yes" if DPULEMBOL < DOptoDis

gen InitialFAILWEAN = "No"
replace InitialFAILWEAN = "Yes" if DFAILWEAN < DOptoDis

gen InitialOPRENAFL = "No"
replace InitialOPRENAFL = "Yes" if DOPRENAFL < DOptoDis

gen InitialURNINFEC = "No"
replace InitialURNINFEC = "Yes" if DURNINFEC < DOptoDis

gen InitialCNSCVA = "No"
replace InitialCNSCVA = "Yes" if DCNSCVA < DOptoDis

gen InitialCDARREST = "No"
replace InitialCDARREST = "Yes" if DCDARREST < DOptoDis

gen InitialCDMI = "No"
replace InitialCDMI = "Yes" if DCDMI < DOptoDis

gen InitialOTHBLEED = "No"
replace InitialOTHBLEED = "Yes" if DOTHBLEED < DOptoDis

gen InitialOTHDVT = "No"
replace InitialOTHDVT = "Yes" if DOTHDVT < DOptoDis

gen InitialREOPERATION1 = "No"
replace InitialREOPERATION1 = "Yes" if RETORPODAYS < DOptoDis

gen InitialOTHCDIFF = "No"
replace InitialOTHCDIFF = "Yes" if DOTHCDIFF < DOptoDis

save "Y:\Tyler Zander\NSQIP\Z4_NSQIP_2018_2021V7.dta", replace

*****************************************************************
*Step 6: Feature Engineering of Disposition, PATOS, and Race Categories

clear
use "Y:\Tyler Zander\NSQIP\Z4_NSQIP_2018_2021V7.dta"

tab RACE_NEW

replace RACE_NEW = "" if RACE_NEW == "Unknown/Not Reported"

mdesc RACE_NEW

gen RACE_COMBINED = RACE_NEW
replace RACE_COMBINED = "Other Race" if inlist(RACE_NEW, "White,Asian", "Asian,Some Other Race", "Black or African American,American Indian or Alaska Native", "Race combinations with low frequency", "White,American Indian or Alaska Native", "White,Black or African American", "Native Hawaiian or Other Pacific Islander,Asian")

replace RACE_COMBINED = "Other Race" if inlist(RACE_NEW, "White,Some Other Race", "White,Unknown/Not Reported", "White,Native Hawaiian or Other Pacific Islander", "Native Hawaiian or Pacific Islander", "Native Hawaiian or Other Pacific Islander", "Native Hawaiian or Pacific Islander", "Native Hawaiian or Other Pacific Islander", "American Indian or Alaska Native", "Some Other Race")

label define race_combined_label 1 "Asian" 2 "Black or African American" 3 "White" 4 "Other Race"

encode RACE_COMBINED, gen(RACE_COMBINED_NUM) label(race_combined_label)

tab RACE_COMBINED_NUM, missing

*Combine Acute care hospital categories
replace TRANST = "Acute care hospital transfer" if inlist(TRANST, "Acute care hospital", "From acute care hospital inpatient")

*Combine Home categories
replace TRANST = "Home" if inlist(TRANST, "Home/Permanent residence", "Not transferred (admitted from home)")

*Combine Other categories
replace TRANST = "Other" if inlist(TRANST, "Other facility", "Transfer from other")

*Relabel the variable
label variable TRANST "Origin Status (Combined)"

*Display the new distribution
tab TRANST

*Combine Acute Care Hospital categories
replace DISCHDEST = "Acute Care Hospital" if inlist(DISCHDEST, "Acute Care Hospital", "Separate Acute Care")

*Combine Home categories
replace DISCHDEST = "Home" if inlist(DISCHDEST, "Home", "Home/Permanent Residence")

*Combine Other facilities
replace DISCHDEST = "Other Facility" if DISCHDEST == "Multi-level Senior Community"

*Relabel the variable
label variable DISCHDEST "Discharge Destination (Combined)"

*Display the new distribution
tab DISCHDEST

*Feature engineer PATOS to prevent data leakage
gen ZSSSIPATOS = "No"
replace ZSSSIPATOS = "Yes" if SSSIPATOS == "Yes" & InitialSUPINFEC == "Yes"

gen ZDSSIPATOS = "No"
replace ZDSSIPATOS = "Yes" if DSSIPATOS == "Yes" & InitialWNDINFD == "Yes"

gen ZOSSIPATOS = "No"
replace ZOSSIPATOS = "Yes" if OSSIPATOS == "Yes" & InitialORGSPCSSI == "Yes"

gen ZPNAPATOS = "No"
replace ZPNAPATOS = "Yes" if PNAPATOS == "Yes" & InitialOUPNEUMO == "Yes"

gen ZVENTPATOS = "No"
replace ZVENTPATOS = "Yes" if VENTPATOS == "Yes" & InitialFAILWEAN == "Yes"

gen ZUTIPATOS = "No"
replace ZUTIPATOS = "Yes" if UTIPATOS == "Yes" & InitialURNINFEC == "Yes"

gen ZSEPSISPATOS = "No"
replace ZSEPSISPATOS = "Yes" if SEPSISPATOS == "Yes" & InitialSepsis == "Yes"

gen ZSEPSHOCKPATOS = "No"
replace ZSEPSHOCKPATOS = "Yes" if SEPSHOCKPATOS == "Yes" & InitialShock == "Yes"

* Rename variables by removing Z prefix
drop SSSIPATOS DSSIPATOS OSSIPATOS PNAPATOS VENTPATOS UTIPATOS SEPSISPATOS SEPSHOCKPATOS

rename ZSSSIPATOS SSSIPATOS
rename ZDSSIPATOS DSSIPATOS
rename ZOSSIPATOS OSSIPATOS
rename ZPNAPATOS PNAPATOS
rename ZVENTPATOS VENTPATOS
rename ZUTIPATOS UTIPATOS
rename ZSEPSISPATOS SEPSISPATOS
rename ZSEPSHOCKPATOS SEPSHOCKPATOS

save "Y:\Tyler Zander\NSQIP\Z4_NSQIP_2018_2021V8.dta", replace

*********************************************************************************************************************************
*Step 7: Feature engineering days to complications and total WRVU. Combine the outcome of 14-day mortality and unplanned readmission. Keep variables for modeling.

clear
use "Y:\Tyler Zander\NSQIP\Z4_NSQIP_2018_2021V8.dta"

mdesc

*Feature engineering days to complications to avoid data leakage

replace DSUPINFEC = . if InitialSUPINFEC == "No"
replace DWNDINFD = . if InitialWNDINFD == "No"
replace DORGSPCSSI = . if InitialORGSPCSSI == "No"
replace DDEHIS = . if InitialDEHIS == "No"
replace DOUPNEUMO = . if InitialOUPNEUMO == "No"
replace DREINTUB = . if InitialREINTUB == "No"
replace DPULEMBOL = . if InitialPULEMBOL == "No"
replace DFAILWEAN = . if InitialFAILWEAN == "No"
replace DOPRENAFL = . if InitialOPRENAFL == "No"
replace DURNINFEC = . if InitialURNINFEC == "No"
replace DCNSCVA = . if InitialCNSCVA == "No"
replace DCDARREST = . if InitialCDARREST == "No"
replace DCDMI = . if InitialCDMI == "No"
replace DOTHBLEED = . if InitialOTHBLEED == "No"
replace DOTHDVT = . if InitialOTHDVT == "No"
replace DOTHSYSEP = . if InitialSepsis == "No"
replace DOTHSESHOCK = . if InitialShock == "No"
replace RETORPODAYS = . if InitialREOPERATION1 == "No"

* Make -99 values missing values
local vars OTHERWRVU1 OTHERWRVU2 OTHERWRVU3 OTHERWRVU4 OTHERWRVU5 OTHERWRVU6 OTHERWRVU7 OTHERWRVU8 OTHERWRVU9 OTHERWRVU10 CONWRVU1 CONWRVU2 CONWRVU3 CONWRVU4 CONWRVU5 CONWRVU6 CONWRVU7 CONWRVU8 CONWRVU9 CONWRVU10

* Loop through each variable and replace -99 with missing value
foreach var in `vars' {
    replace `var' = 0 if `var' == -99
}

*Calculate Total WRVU
gen TOTAL_WRVU = WORKRVU + OTHERWRVU1 + OTHERWRVU2 + OTHERWRVU3 + OTHERWRVU4 + OTHERWRVU5 + OTHERWRVU6 + OTHERWRVU7 + OTHERWRVU8 + OTHERWRVU9 + OTHERWRVU10 + CONWRVU1 + CONWRVU2 + CONWRVU3 + CONWRVU4 + CONWRVU5 + CONWRVU6 + CONWRVU7 + CONWRVU8 + CONWRVU9 + CONWRVU10

gen Additional_CPT_Count = 0

local cpt_vars OTHERCPT1 OTHERCPT2 OTHERCPT3 OTHERCPT4 OTHERCPT5 ///
               OTHERCPT6 OTHERCPT7 OTHERCPT8 OTHERCPT9 OTHERCPT10 ///
               CONCPT1 CONCPT2 CONCPT3 CONCPT4 CONCPT5 ///
               CONCPT6 CONCPT7 CONCPT8 CONCPT9 CONCPT10

foreach var of local cpt_vars {
    replace Additional_CPT_Count = Additional_CPT_Count + 1 if `var' != "NULL" & `var' != ""
}

list Additional_CPT_Count if _n <= 10  // Display first 10 rows to check results

*Create 14-day unplannedreadmission or 14-day post-discharge mortality outcome variable
gen DCtoDeath = DOpertoD - DOptoDis

gen Death2 = "No"

replace Death2 = "Yes"  if DCtoDeath == 0 | DCtoDeath == 1 | DCtoDeath == 2 | DCtoDeath == 3 | DCtoDeath == 4 | DCtoDeath == 5 | DCtoDeath == 6 | DCtoDeath == 7 | DCtoDeath == 8 | DCtoDeath == 9 | DCtoDeath == 10 | DCtoDeath == 11 | DCtoDeath == 12 | DCtoDeath == 13 | DCtoDeath == 14

tab UNPLANNEDREADMISSION1

gen DeathorReadmit = "No"
replace DeathorReadmit = "Yes" if Death2 == "Yes" | UNPLANNEDREADMISSION1 == "Yes"

drop UNPLANNEDREADMISSION1
drop Death2
rename DeathorReadmit UNPLANNEDREADMISSION1

*Keep variables for modeling
keep CaseID SEX ETHNICITY_HISPANIC RACE_COMBINED_NUM WORKRVU TRANST Age ANESTHES SURGSPEC HEIGHT WEIGHT DIABETES SMOKE FNSTATUS2 VENTILAT HXCOPD ASCITES HXCHF HYPERMED DIALYSIS DISCANCR STEROID BLEEDDIS TRANSFUS PRSEPIS PRSODM PRBUN PRCREAT PRALBUM PRBILI PRSGOT PRALKPH PRWBC PRHCT PRPLATE PRPTT PRINR MORTPROB MORBPROB OPTIME HtoODay DOptoDis SSSIPATOS DSSIPATOS OSSIPATOS PNAPATOS VENTPATOS UTIPATOS SEPSISPATOS SEPSHOCKPATOS ASACLAS InitialShock InitialSepsis InitialSUPINFEC InitialWNDINFD InitialORGSPCSSI InitialDEHIS InitialOUPNEUMO InitialREINTUB InitialPULEMBOL InitialFAILWEAN InitialOPRENAFL InitialURNINFEC InitialCNSCVA InitialCDARREST InitialCDMI InitialOTHBLEED InitialOTHDVT InitialREOPERATION1 InitialOTHCDIFF DSUPINFEC DWNDINFD DORGSPCSSI DDEHIS DOUPNEUMO DREINTUB DPULEMBOL DFAILWEAN DOPRENAFL DURNINFEC DCNSCVA DCDARREST DCDMI DOTHBLEED DOTHDVT DOTHSYSEP DOTHSESHOCK RETORPODAYS TOTAL_WRVU Additional_CPT_Count UNPLANNEDREADMISSION1 DISCHDEST


save "Y:\Tyler Zander\NSQIP\Z4_NSQIP_2018_2021V9.dta",replace

export delimited "Y:\Tyler Zander\NSQIP\Z4_NSQIP_2018_2021V9.csv", replace

*****************************************************************
*Step 8: Univariable analysis

clear
use "Y:\Tyler Zander\NSQIP\Z4_NSQIP_2018_2021V9.dta"

table1_mc, by(UNPLANNEDREADMISSION1) vars(SEX cat\ ETHNICITY_HISPANIC cat\ RACE_COMBINED_NUM cat\ TRANST cat\ DISCHDEST cat\ ANESTHES cat\ SURGSPEC cat\ DIABETES cat\ SMOKE cat\ FNSTATUS2 cat\ VENTILAT cat\ HXCOPD cat\ ASCITES cat\ HXCHF cat\ HYPERMED cat\ DIALYSIS cat\ DISCANCR cat\ STEROID cat\ BLEEDDIS cat\ TRANSFUS cat\ PRSEPIS cat\ SSSIPATOS cat\ DSSIPATOS cat\ OSSIPATOS cat\ PNAPATOS cat\ VENTPATOS cat\ UTIPATOS cat\ SEPSISPATOS cat\ SEPSHOCKPATOS cat\ InitialShock cat\ InitialSepsis cat\ InitialSUPINFEC cat\ InitialWNDINFD cat\ InitialORGSPCSSI cat\ InitialDEHIS cat\ InitialOUPNEUMO cat\ InitialREINTUB cat\ InitialPULEMBOL cat\ InitialFAILWEAN cat\ InitialOPRENAFL cat\ InitialURNINFEC cat\ InitialCNSCVA cat\ InitialCDARREST cat\ InitialCDMI cat\ InitialOTHBLEED cat\ InitialOTHDVT cat\ InitialREOPERATION1 cat\ InitialOTHCDIFF cat\) total(before) saving(Z4SepsisMortalityReadmitChiSqZV2.csv)

table1_mc, by(UNPLANNEDREADMISSION1) vars(Age conts\ HEIGHT conts\ WEIGHT conts\ PRSODM conts\ PRBUN conts\ PRCREAT conts\ PRALBUM conts\ PRBILI conts\ PRSGOT conts\ PRALKPH conts\ PRWBC conts\ PRHCT conts\ PRPLATE conts\ PRPTT conts\ PRINR conts\ MORTPROB conts\ MORBPROB conts\ OPTIME conts\ HtoODay conts\ DOptoDis conts\ ASACLAS conts\ WORKRVU conts\ TOTAL_WRVU conts\ Additional_CPT_Count conts\ RETORPODAYS conts\ DSUPINFEC conts\ DWNDINFD conts\ DORGSPCSSI conts\ DDEHIS conts\ DOUPNEUMO conts\ DREINTUB conts\ DPULEMBOL conts\ DFAILWEAN conts\ DOPRENAFL conts\ DURNINFEC conts\ DCNSCVA conts\ DCDARREST conts\ DCDMI conts\ DOTHBLEED conts\ DOTHDVT conts\ DOTHSYSEP conts\ DOTHSESHOCK conts\) total(before) saving(Z4SepsisMortalityReadmitUTestZV3.csv)

*****************************************************************
*Step 9: Exclude variables with >10% missing for MICE & SMOTE

clear
use "Y:\Tyler Zander\NSQIP\Z4_NSQIP_2018_2021V9.dta"

mdesc

drop PRALBUM PRBILI PRSGOT PRALKPH PRPTT PRINR DSUPINFEC DWNDINFD DORGSPCSSI DDEHIS DOUPNEUMO DREINTUB DPULEMBOL DFAILWEAN DOPRENAFL DURNINFEC DCNSCVA DCDARREST DCDMI DOTHBLEED DOTHDVT DOTHSYSEP DOTHSESHOCK RETORPODAYS

mdesc

save "Y:\Tyler Zander\NSQIP\Z4_NSQIP_2018_2021V10.dta",replace

export delimited "Y:\Tyler Zander\NSQIP\Z4_NSQIP_2018_2021V10.csv", replace


